import{d as H,_ as R,a as I,b as h,c as G}from"./Bnx0PPvk.js";import{_ as J}from"./CCRcQfJ_.js";import{_ as K}from"./BgC2Tqll.js";import{_ as Q}from"./C3Ar38eF.js";import{_ as W}from"./D3KgOzdW.js";import{g as X,k as Y,j as Z,O as ee,r as C,m as se,l as E,C as L,p as N,w as t,o as i,b as a,q as re,a as m,d as f,t as A,v as s,c as w,z as O,H as ae}from"./C4cmwJeW.js";import{u as oe}from"./CGIFyomv.js";const te={class:"grid grid-cols-2 gap-2 pt-2"},ne={key:0},le={key:1},de={class:"grid grid-cols-2 gap-4"},ie={key:0},ue={key:1},pe={key:2},me={key:3},fe={key:0},we={key:1},xe=X({__name:"login",setup(ce){const{$api:P}=Y(),u=Z(),S=ee(),p=C("login"),c=C([]),g=C(!1),V=C(!1),U=se(()=>u.loading||u.registerLoading||V.value),k=E({username:"",password:""}),r=E({username:"",nickname:"",email:"",password:"",password2:""}),q=o=>{const e=o,n=e?.response?.data;if(!n)return[e?.message||"请求失败"];if(typeof n=="string")return[n];if(Array.isArray(n))return n.map(String);if(typeof n=="object"){if(Array.isArray(n.password))return n.password.map(String);const b=Object.values(n).flatMap(d=>Array.isArray(d)?d.map(String):typeof d=="string"?[d]:[]);if(b.length)return b}return["请求失败"]},B=(o,e)=>q(o)[0]||e,j=async()=>{const o={username:k.username.trim(),password:k.password};if(!o.username||!o.password){_("请输入账号和密码");return}try{await u.login(o),await u.fetchProfile(),S.push("/")}catch(e){console.error(e),_(B(e,"登录失败，请检查凭证"))}},$=async()=>{if(p.value!=="register")return!0;if(!r.password)return c.value=[],g.value=!1,!1;V.value=!0;try{return await P.post("/users/password/validate/",{username:r.username.trim(),email:r.email.trim(),password:r.password}),c.value=[],g.value=!0,!0}catch(o){return c.value=q(o),g.value=!1,!1}finally{V.value=!1}},D=oe($,400);L([()=>r.password,()=>r.username,()=>r.email],()=>{if(p.value==="register"){if(!r.password){c.value=[],g.value=!1;return}D()}}),L(()=>p.value,o=>{o==="register"&&r.password?$():(c.value=[],g.value=!1)});const F=async()=>{const o=r.username.trim(),e=r.nickname.trim(),n=r.email.trim();if(!o||!r.password||!r.password2){_("请填写必填项（用户名和两次密码）");return}if(r.password!==r.password2){_("两次输入的密码不一致");return}if(!await $()){_(c.value[0]||"请根据提示调整密码");return}const d={username:o,password:r.password,password2:r.password2};e&&(d.nickname=e),n&&(d.email=n);try{await u.register(d),_("注册成功，正在为您登录"),await u.login({username:o,password:r.password}),await u.fetchProfile(),S.push("/")}catch(x){console.error(x),_(B(x,"注册失败，请检查信息是否有效或已被占用"))}},_=o=>{window.alert(o)};return(o,e)=>{const n=I,b=h,d=J,x=R,y=K,v=Q,M=G,T=W,z=H;return i(),N(z,{class:"w-full max-w-md border border-border/60 bg-card shadow-none"},{default:t(()=>[a(x,{class:"space-y-3"},{default:t(()=>[a(n,null,{default:t(()=>[f(A(s(p)==="login"?"账号登录":"快速注册"),1)]),_:1}),a(b,null,{default:t(()=>[f(A(s(p)==="login"?"使用已有账号登录澄源反诈平台":"创建新的普通用户账号（如需管理员权限请联系平台）"),1)]),_:1}),m("div",te,[a(d,{type:"button",variant:s(p)==="login"?"default":"outline",class:"w-full",disabled:s(U),onClick:e[0]||(e[0]=l=>p.value="login")},{default:t(()=>[...e[9]||(e[9]=[f(" 登录 ",-1)])]),_:1},8,["variant","disabled"]),a(d,{type:"button",variant:s(p)==="register"?"default":"outline",class:"w-full",disabled:s(U),onClick:e[1]||(e[1]=l=>p.value="register")},{default:t(()=>[...e[10]||(e[10]=[f(" 注册 ",-1)])]),_:1},8,["variant","disabled"])])]),_:1}),a(M,null,{default:t(()=>[s(p)==="login"?(i(),w("form",{key:0,class:"space-y-4",onSubmit:O(j,["prevent"])},[m("div",null,[a(y,{for:"username"},{default:t(()=>[...e[11]||(e[11]=[f("账号 / 邮箱 / 手机",-1)])]),_:1}),a(v,{id:"username",name:"username",modelValue:s(k).username,"onUpdate:modelValue":e[2]||(e[2]=l=>s(k).username=l),required:"",autocomplete:"username",placeholder:"admin"},null,8,["modelValue"])]),m("div",null,[a(y,{for:"password"},{default:t(()=>[...e[12]||(e[12]=[f("密码",-1)])]),_:1}),a(v,{id:"password",name:"password",modelValue:s(k).password,"onUpdate:modelValue":e[3]||(e[3]=l=>s(k).password=l),type:"password",required:"",autocomplete:"current-password",placeholder:"请输入密码"},null,8,["modelValue"])]),a(d,{type:"submit",class:"w-full",disabled:s(u).loading},{default:t(()=>[s(u).loading?(i(),w("span",ne,"登录中...")):(i(),w("span",le,"登录"))]),_:1},8,["disabled"])],32)):(i(),w("form",{key:1,class:"space-y-4",onSubmit:O(F,["prevent"])},[m("div",null,[a(y,{for:"register-username"},{default:t(()=>[...e[13]||(e[13]=[f("用户名*",-1)])]),_:1}),a(v,{id:"register-username",modelValue:s(r).username,"onUpdate:modelValue":e[4]||(e[4]=l=>s(r).username=l),required:"",autocomplete:"off",placeholder:"new_user"},null,8,["modelValue"])]),m("div",de,[m("div",null,[a(y,{for:"register-nickname"},{default:t(()=>[...e[14]||(e[14]=[f("昵称",-1)])]),_:1}),a(v,{id:"register-nickname",modelValue:s(r).nickname,"onUpdate:modelValue":e[5]||(e[5]=l=>s(r).nickname=l),autocomplete:"off",placeholder:"可选"},null,8,["modelValue"])]),m("div",null,[a(y,{for:"register-email"},{default:t(()=>[...e[15]||(e[15]=[f("邮箱",-1)])]),_:1}),a(v,{id:"register-email",modelValue:s(r).email,"onUpdate:modelValue":e[6]||(e[6]=l=>s(r).email=l),type:"email",autocomplete:"off",placeholder:"可选"},null,8,["modelValue"])])]),m("div",null,[a(y,{for:"register-password"},{default:t(()=>[...e[16]||(e[16]=[f("密码*",-1)])]),_:1}),a(v,{id:"register-password",modelValue:s(r).password,"onUpdate:modelValue":e[7]||(e[7]=l=>s(r).password=l),type:"password",required:"",autocomplete:"new-password",placeholder:"至少 8 位且非常见密码"},null,8,["modelValue"]),m("p",{class:ae(["text-xs min-h-[1.25rem]",s(c).length?"text-destructive":s(g)?"text-emerald-600":"text-muted-foreground"])},[s(V)?(i(),w("span",ie,"正在校验密码强度...")):s(c).length?(i(),w("span",ue,A(s(c)[0]),1)):s(g)?(i(),w("span",pe,"密码符合当前安全要求")):(i(),w("span",me,"密码需满足平台设定的长度与复杂度要求"))],2)]),m("div",null,[a(y,{for:"register-password2"},{default:t(()=>[...e[17]||(e[17]=[f("确认密码*",-1)])]),_:1}),a(v,{id:"register-password2",modelValue:s(r).password2,"onUpdate:modelValue":e[8]||(e[8]=l=>s(r).password2=l),type:"password",required:"",autocomplete:"new-password",placeholder:"再次输入密码"},null,8,["modelValue"])]),a(d,{type:"submit",class:"w-full",disabled:s(u).registerLoading||s(V)},{default:t(()=>[s(u).registerLoading?(i(),w("span",fe,"注册中...")):(i(),w("span",we,"注册并登录"))]),_:1},8,["disabled"])],32))]),_:1}),s(p)==="register"?(i(),N(T,{key:0,class:"text-xs text-muted-foreground leading-relaxed"},{default:t(()=>[...e[18]||(e[18]=[m("p",null,"注册创建的账户默认为普通用户，如需管理员权限请联系平台维护人员。",-1)])]),_:1})):re("",!0)]),_:1})}}});export{xe as default};
