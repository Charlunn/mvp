import{_ as De}from"./pP1PrXx_.js";import{_ as Ve}from"./BgC2Tqll.js";import{c as Z,_ as Ae}from"./CCRcQfJ_.js";import{_ as Se}from"./DzNSn88N.js";import{d as Fe,_ as Le,a as Pe,b as Te,c as Be}from"./Bnx0PPvk.js";import{_ as Ue}from"./C3Ar38eF.js";import{_ as je}from"./BtdkqM2g.js";import{_ as Ne}from"./38tOet_I.js";import{_ as qe}from"./D3KgOzdW.js";import{b as ze,g as He}from"./VUKfmkwN.js";import{g as le,p as U,o as i,w as o,b as t,v as n,H as re,B as Me,k as Ee,j as Ie,r as g,l as ee,n as We,C as Re,c as u,a as r,q as k,x as te,A as oe,E as se,F as w,s as B,W as h,d as a,t as m,z as J,N as ne}from"./C4cmwJeW.js";import"./CTtaAHph.js";const Ge=le({__name:"switch",props:{class:{}},setup(K){const y=K;return(z,C)=>(i(),U(n(He),Me(z.$attrs,{class:n(Z)("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",y.class)}),{default:o(()=>[t(n(ze),{class:re(n(Z)("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"))},null,8,["class"])]),_:1},16,["class"]))}}),Je={class:"space-y-6"},Ke={class:"rounded-lg border border-dashed border-border/70 bg-muted/20 px-4 py-3 text-sm"},Oe={class:"flex flex-wrap items-center gap-3"},Qe={class:"flex flex-col"},Xe=["disabled"],Ye=["value"],Ze={class:"flex items-center gap-2 text-xs text-muted-foreground"},et={key:0},tt={key:0,class:"flex justify-end"},ot={class:"grid gap-6 lg:grid-cols-[2fr_1fr]"},st={class:"space-y-4"},nt={class:"grid gap-4"},lt=["disabled"],rt=["value"],at={key:0,class:"mt-2 text-xs text-muted-foreground"},it={class:"flex items-center justify-end gap-3"},dt={class:"space-y-4"},ut={class:"flex items-center justify-between"},mt={key:0,class:"rounded-lg border border-dashed border-border/70 p-6 text-sm text-muted-foreground"},ct={key:1,class:"rounded-lg border border-dashed border-border/70 p-6 text-sm text-muted-foreground"},ft={key:2,class:"space-y-4"},pt={class:"flex items-center justify-between text-xs text-muted-foreground"},gt={class:"whitespace-pre-line text-sm leading-relaxed"},_t={key:0,class:"grid gap-3 md:grid-cols-2"},yt=["src"],bt={class:"flex items-center gap-4 text-muted-foreground"},vt=["onClick"],xt={class:"flex items-center gap-1"},kt={key:0,class:"flex justify-center"},wt={class:"space-y-4"},ht={key:0,class:"text-muted-foreground"},Ct={key:1,class:"text-muted-foreground"},$t={key:2,class:"space-y-3"},Dt={class:"mt-1 text-xs text-muted-foreground"},Vt={class:"grid grid-cols-4 items-center gap-4"},At={class:"grid grid-cols-4 items-center gap-4"},St={class:"grid grid-cols-4 items-center gap-4"},Ft={class:"grid grid-cols-4 items-center gap-4"},It=le({__name:"index",setup(K){const{$api:y,$config:z}=Ee(),C=Ie(),H=g([]),M=g(!0),x=g([]),b=g(!1),O=g(1),E=g(!1),j=g(!1),$=g(!1),N=g(!1),q=g([]),D=g(!1),c=g(""),p=ee({name:"",slug:"",description:"",is_private:!1}),ae=async()=>{N.value=!0;try{await y.post("/community/communities/",p),window.alert("社区创建成功！"),$.value=!1,p.name="",p.slug="",p.description="",p.is_private=!1,await X()}catch(l){console.error("创建社区失败",l);const e=l;window.alert(e.response?.data?.detail||"创建社区失败，请稍后重试")}finally{N.value=!1}},d=ee({community:"",title:"",body:"",images:[]}),Q=g(null),ie=()=>{Q.value?.click()},X=async()=>{D.value=!0;try{const{data:l}=await y.get("/community/communities/",{params:{page_size:100}}),e=Array.isArray(l)?l:l.results||[];q.value=e,!c.value&&e.length===1&&(c.value=String(e[0].id)),d.community||(c.value?d.community=c.value:e.length===1&&(d.community=String(e[0].id))),e.length||window.alert("未找到任何社区，无法发布帖子。请联系管理员")}catch(l){console.error("加载社区列表失败",l),window.alert("加载社区列表失败，请稍后重试")}finally{D.value=!1}},de=async()=>{M.value=!0;try{const{data:l}=await y.get("/community/posts/",{params:{ordering:"-like_count,-created_at",page_size:5}});H.value=Array.isArray(l)?l:l.results||[]}catch(l){console.error("加载热帖失败",l)}finally{M.value=!1}},I=async(l=1,e=!1)=>{b.value=!0;try{const v={page:l};c.value&&(v.community=c.value);const{data:f}=await y.get("/community/posts/",{params:v}),_=Array.isArray(f)?f:f.results||[];e?x.value=[...x.value,..._]:x.value=_,E.value=!!f?.next,O.value=l}catch(v){console.error("加载帖子失败",v)}finally{b.value=!1}},W=()=>I(1,!1),ue=()=>{b.value||!E.value||I(O.value+1,!0)},me=()=>{c.value=""},ce=l=>{const e=l.target;d.images=Array.from(e.files??[])},fe=async()=>{if(!d.title.trim()||!d.body.trim()){window.alert("标题和内容不能为空");return}if(!d.community){window.alert("请先选择要发布到的社区");return}j.value=!0;try{const l=new FormData;l.append("community",d.community),l.append("title",d.title),l.append("body",d.body),d.images.forEach(e=>l.append("images",e)),await y.post("/community/posts/",l,{headers:{"Content-Type":"multipart/form-data"}}),window.alert("帖子已发布"),d.title="",d.body="",d.images=[],d.community=c.value||"",await W()}catch(l){console.error("发布帖子失败",l);const e=l;window.alert(e.response?.data?.detail||"发布失败，请稍后重试")}finally{j.value=!1}},pe=(l,e)=>{e.target.closest("a, button")||ne(`/community/posts/${l}`)},ge=async l=>{if(!C.isAuthenticated){window.alert("请先登录后再点赞");return}try{const{data:e}=await y.post(`/community/posts/${l.id}/like/`);l.is_liked=!!e?.liked,typeof e?.like_count=="number"&&(l.like_count=e.like_count)}catch(e){console.error("点赞失败",e)}},_e=l=>l?l.startsWith("http")?l:`${z.public.apiBase?.replace(/\/$/,"")??""}${l}`:"",ye=l=>{try{return new Date(l).toLocaleString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return l}};return We(async()=>{await X(),await de(),await I()}),Re(c,()=>{W(),c.value&&(d.community=c.value)}),(l,e)=>{const v=De,f=Ve,_=Ae,V=Se,A=Pe,S=Te,F=Le,R=Ue,Y=je,L=Be,P=Fe,G=Ne,be=qe,ve=h("DialogTitle"),xe=h("DialogDescription"),ke=h("DialogHeader"),we=Ge,he=h("DialogFooter"),Ce=h("DialogContent"),$e=h("Dialog");return i(),u(w,null,[r("div",Je,[t(v,{title:"社区广场",description:"与反诈同行者分享经验、讨论案例，构建可信赖的知识社区"}),r("div",Ke,[r("div",Oe,[r("div",Qe,[t(f,{for:"community-filter",class:"text-sm font-medium text-muted-foreground"},{default:o(()=>[...e[11]||(e[11]=[a("筛选社区",-1)])]),_:1}),te(r("select",{id:"community-filter","onUpdate:modelValue":e[0]||(e[0]=s=>se(c)?c.value=s:null),class:"mt-1 rounded-md border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary",disabled:n(D)},[e[12]||(e[12]=r("option",{value:""},"全部社区",-1)),(i(!0),u(w,null,B(n(q),s=>(i(),u("option",{key:s.id,value:String(s.id)},m(s.name),9,Ye))),128))],8,Xe),[[oe,n(c)]])]),r("div",Ze,[n(D)?(i(),u("span",et,"正在加载社区...")):k("",!0),n(c)?(i(),U(_,{key:1,variant:"ghost",size:"sm",onClick:me},{default:o(()=>[...e[13]||(e[13]=[a("清除筛选",-1)])]),_:1})):k("",!0)])])]),n(C).isAuthenticated&&n(C).user?.is_staff?(i(),u("div",tt,[t(_,{onClick:e[1]||(e[1]=s=>$.value=!0)},{default:o(()=>[t(V,{name:"lucide:plus",class:"mr-2 h-4 w-4"}),e[14]||(e[14]=a(" 创建新社区 ",-1))]),_:1})])):k("",!0),r("section",ot,[r("div",st,[n(C).isAuthenticated?(i(),U(P,{key:0,class:"border border-border/70 bg-secondary/30"},{default:o(()=>[t(F,null,{default:o(()=>[t(A,null,{default:o(()=>[...e[15]||(e[15]=[a("发表新帖",-1)])]),_:1}),t(S,null,{default:o(()=>[...e[16]||(e[16]=[a("分享最新的防骗提示或求助讨论，让更多人及时警觉",-1)])]),_:1})]),_:1}),t(L,null,{default:o(()=>[r("form",{class:"space-y-4",onSubmit:J(fe,["prevent"])},[r("div",nt,[r("div",null,[t(f,{for:"post-community"},{default:o(()=>[...e[17]||(e[17]=[a("发布到社区",-1)])]),_:1}),te(r("select",{id:"post-community","onUpdate:modelValue":e[2]||(e[2]=s=>n(d).community=s),class:"mt-1 w-full rounded-md border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary",disabled:n(D)||!n(q).length,required:""},[e[18]||(e[18]=r("option",{value:"",disabled:""},"请选择社区",-1)),(i(!0),u(w,null,B(n(q),s=>(i(),u("option",{key:s.id,value:String(s.id)},m(s.name),9,rt))),128))],8,lt),[[oe,n(d).community]]),e[19]||(e[19]=r("p",{class:"mt-1 text-xs text-muted-foreground"},"只有选择了社区，帖子才能发布。",-1))]),r("div",null,[t(f,{for:"title"},{default:o(()=>[...e[20]||(e[20]=[a("帖子标题",-1)])]),_:1}),t(R,{id:"title",modelValue:n(d).title,"onUpdate:modelValue":e[3]||(e[3]=s=>n(d).title=s),placeholder:"一句话总结你的观点",required:""},null,8,["modelValue"])])]),r("div",null,[t(f,{for:"body"},{default:o(()=>[...e[21]||(e[21]=[a("内容",-1)])]),_:1}),t(Y,{id:"body",modelValue:n(d).body,"onUpdate:modelValue":e[4]||(e[4]=s=>n(d).body=s),rows:"4",placeholder:"分享你的反诈经验、风险提示或求助问题",required:""},null,8,["modelValue"])]),r("div",null,[t(f,{class:"mb-1 block text-sm font-medium text-muted-foreground"},{default:o(()=>[...e[22]||(e[22]=[a("上传图片（可选）",-1)])]),_:1}),r("input",{ref_key:"fileInput",ref:Q,type:"file",multiple:"",accept:"image/*",class:"hidden",onChange:ce},null,544),t(_,{type:"button",variant:"outline",onClick:ie},{default:o(()=>[t(V,{name:"lucide:upload",class:"mr-2 h-4 w-4"}),e[23]||(e[23]=a(" 选择图片 ",-1))]),_:1}),n(d).images.length?(i(),u("p",at," 已选择 "+m(n(d).images.length)+" 张图片 ",1)):k("",!0)]),r("div",it,[t(_,{type:"submit",disabled:n(j)},{default:o(()=>[a(m(n(j)?"发布中...":"发布帖子"),1)]),_:1},8,["disabled"])])],32)]),_:1})]),_:1})):(i(),U(P,{key:1,class:"border border-border/70 bg-muted/30"},{default:o(()=>[t(F,null,{default:o(()=>[t(A,null,{default:o(()=>[...e[24]||(e[24]=[a("登录后参与讨论",-1)])]),_:1}),t(S,null,{default:o(()=>[...e[25]||(e[25]=[a("登录账号即可发帖、点赞和评论",-1)])]),_:1})]),_:1}),t(L,null,{default:o(()=>[t(_,{class:"w-full",onClick:e[5]||(e[5]=s=>("navigateTo"in l?l.navigateTo:n(ne))("/login"))},{default:o(()=>[...e[26]||(e[26]=[a("前往登录",-1)])]),_:1})]),_:1})]),_:1})),r("div",dt,[r("div",ut,[e[28]||(e[28]=r("h2",{class:"text-lg font-semibold"},"社区热帖",-1)),t(_,{variant:"outline",size:"sm",disabled:n(b),onClick:W},{default:o(()=>[t(V,{name:"lucide:refresh-cw",class:"mr-1 h-4 w-4"}),e[27]||(e[27]=a(" 刷新 ",-1))]),_:1},8,["disabled"])]),n(b)&&!n(x).length?(i(),u("div",mt," 正在加载社区内容... ")):n(x).length?(i(),u("div",ft,[(i(!0),u(w,null,B(n(x),s=>(i(),U(P,{key:s.id,class:"cursor-pointer border border-border/70 transition-colors hover:bg-muted/50",onClick:T=>pe(s.id,T)},{default:o(()=>[t(F,{class:"space-y-1"},{default:o(()=>[r("div",pt,[r("div",null,[e[29]||(e[29]=a(" 发布于 ",-1)),t(G,{to:`/community/${s.community_detail.slug}`,class:"font-medium text-foreground hover:underline"},{default:o(()=>[a(m(s.community_detail.name),1)]),_:2},1032,["to"])]),r("span",null,m(ye(s.created_at)),1)]),t(A,{class:"text-xl"},{default:o(()=>[a(m(s.title),1)]),_:2},1024),t(S,null,{default:o(()=>[e[30]||(e[30]=a(" 由 ",-1)),t(G,{to:`/users/${s.author.username}`,class:"font-medium text-foreground hover:underline"},{default:o(()=>[a(m(s.author.nickname||s.author.username),1)]),_:2},1032,["to"]),e[31]||(e[31]=a(" 发布 ",-1))]),_:2},1024)]),_:2},1024),t(L,{class:"space-y-4"},{default:o(()=>[r("p",gt,m(s.body),1),s.images.length?(i(),u("div",_t,[(i(!0),u(w,null,B(s.images,T=>(i(),u("img",{key:T.id,src:_e(T.image),class:"h-48 w-full rounded-lg object-cover",alt:"帖子图片"},null,8,yt))),128))])):k("",!0)]),_:2},1024),t(be,{class:"flex items-center justify-between gap-4 text-sm"},{default:o(()=>[r("div",bt,[r("button",{class:re(["flex items-center gap-1",s.is_liked?"text-primary":""]),onClick:J(T=>ge(s),["stop"])},[t(V,{name:s.is_liked?"lucide:heart":"lucide:heart-off",class:"h-4 w-4"},null,8,["name"]),r("span",null,m(s.like_count),1)],10,vt),r("div",xt,[t(V,{name:"lucide:message-square",class:"h-4 w-4"}),r("span",null,m(s.comment_count),1)])])]),_:2},1024)]),_:2},1032,["onClick"]))),128)),n(E)?(i(),u("div",kt,[t(_,{variant:"outline",disabled:n(b),onClick:ue},{default:o(()=>[a(m(n(b)?"加载中...":"加载更多"),1)]),_:1},8,["disabled"])])):k("",!0)])):(i(),u("div",ct," 暂无帖子，成为第一位分享者吧！ "))])]),r("aside",wt,[t(P,{class:"border border-border/70"},{default:o(()=>[t(F,null,{default:o(()=>[t(A,null,{default:o(()=>[...e[32]||(e[32]=[a("推荐热帖",-1)])]),_:1}),t(S,null,{default:o(()=>[...e[33]||(e[33]=[a("看看大家都在讨论什么",-1)])]),_:1})]),_:1}),t(L,{class:"space-y-3 text-sm"},{default:o(()=>[n(M)?(i(),u("div",ht,"加载中...")):n(H).length?(i(),u("div",$t,[(i(!0),u(w,null,B(n(H),s=>(i(),u("div",{key:s.id,class:"rounded-lg border border-border/70 bg-background/80 p-3"},[t(G,{to:`/community/posts/${s.id}`,class:"font-medium hover:underline"},{default:o(()=>[a(m(s.title),1)]),_:2},1032,["to"]),r("p",Dt,m(s.like_count)+" 人点赞 · "+m(s.comment_count)+" 条评论 ",1)]))),128))])):(i(),u("div",Ct,"暂无热帖"))]),_:1})]),_:1}),t(P,{class:"border border-border/70 bg-secondary/20"},{default:o(()=>[t(F,null,{default:o(()=>[t(A,null,{default:o(()=>[...e[34]||(e[34]=[a("社区守则",-1)])]),_:1}),t(S,null,{default:o(()=>[...e[35]||(e[35]=[a("共建高质量、可信的防诈空间",-1)])]),_:1})]),_:1}),t(L,{class:"space-y-2 text-xs text-muted-foreground"},{default:o(()=>[...e[36]||(e[36]=[r("p",null,"· 分享真实有效的反诈经验和案例，避免传播未经验证的信息。",-1),r("p",null,"· 尊重其他用户的隐私，不公开个人敏感数据。",-1),r("p",null,"· 对异常内容使用举报或提醒社区管理员处理。",-1)])]),_:1})]),_:1})])])]),t($e,{open:n($),"onUpdate:open":e[10]||(e[10]=s=>se($)?$.value=s:null)},{default:o(()=>[t(Ce,null,{default:o(()=>[t(ke,null,{default:o(()=>[t(ve,null,{default:o(()=>[...e[37]||(e[37]=[a("创建新社区",-1)])]),_:1}),t(xe,null,{default:o(()=>[...e[38]||(e[38]=[a("填写社区信息以创建一个新的反诈讨论空间",-1)])]),_:1})]),_:1}),r("form",{class:"grid gap-4 py-4",onSubmit:J(ae,["prevent"])},[r("div",Vt,[t(f,{for:"community-name",class:"text-right"},{default:o(()=>[...e[39]||(e[39]=[a("名称",-1)])]),_:1}),t(R,{id:"community-name",modelValue:n(p).name,"onUpdate:modelValue":e[6]||(e[6]=s=>n(p).name=s),class:"col-span-3",required:""},null,8,["modelValue"])]),r("div",At,[t(f,{for:"community-slug",class:"text-right"},{default:o(()=>[...e[40]||(e[40]=[a("Slug",-1)])]),_:1}),t(R,{id:"community-slug",modelValue:n(p).slug,"onUpdate:modelValue":e[7]||(e[7]=s=>n(p).slug=s),class:"col-span-3",required:""},null,8,["modelValue"])]),r("div",St,[t(f,{for:"community-description",class:"text-right"},{default:o(()=>[...e[41]||(e[41]=[a("描述",-1)])]),_:1}),t(Y,{id:"community-description",modelValue:n(p).description,"onUpdate:modelValue":e[8]||(e[8]=s=>n(p).description=s),class:"col-span-3"},null,8,["modelValue"])]),r("div",Ft,[t(f,{for:"community-private",class:"text-right"},{default:o(()=>[...e[42]||(e[42]=[a("私有社区",-1)])]),_:1}),t(we,{id:"community-private",checked:n(p).is_private,"onUpdate:checked":e[9]||(e[9]=s=>n(p).is_private=s),class:"col-span-3"},null,8,["checked"])]),t(he,null,{default:o(()=>[t(_,{type:"submit",disabled:n(N)},{default:o(()=>[a(m(n(N)?"创建中...":"创建社区"),1)]),_:1},8,["disabled"])]),_:1})],32)]),_:1})]),_:1},8,["open"])],64)}}});export{It as default};
