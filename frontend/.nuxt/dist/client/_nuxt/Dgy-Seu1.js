import{_ as te}from"./pP1PrXx_.js";import{d as se,_ as le,a as ae,b as oe,c as ne}from"./Bnx0PPvk.js";import{_ as re}from"./BgC2Tqll.js";import{_ as ue}from"./BtdkqM2g.js";import{_ as de}from"./DzNSn88N.js";import{_ as ie}from"./CCRcQfJ_.js";import{g as ce,k as fe,r as b,l as me,m as W,n as ve,C as pe,c as v,b as l,w as n,o as c,d as f,a as s,q as P,x as E,F as S,s as $,t as r,A as M,J as _e,H as be,z as ye,p as ge,G as V}from"./C4cmwJeW.js";import{_ as xe}from"./BB_Ta-Np.js";import"./CTtaAHph.js";import"./hg5aJybS.js";const he={class:"space-y-6"},we={class:"grid gap-4 md:grid-cols-3"},ke=["disabled"],Ce=["value"],Ae=["disabled"],Re=["value"],Se=["disabled"],$e=["value"],Ve={class:"rounded-2xl border border-border/70 bg-card p-4"},Le={class:"flex items-center justify-between text-sm"},Te={key:0,class:"text-right"},Be={class:"text-2xl font-semibold"},Ie={class:"text-xs text-muted-foreground"},Pe={key:1,class:"text-xs text-muted-foreground"},Ee={class:"mt-2 h-2 rounded-full bg-muted"},Me={key:0,class:"text-sm text-muted-foreground"},Ne={class:"flex flex-col gap-2"},De={key:0,class:"text-sm text-amber-600"},He={key:0,class:"rounded-2xl border border-border/70 bg-card p-4 text-sm leading-relaxed"},Oe={class:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground uppercase tracking-widest"},Ue={class:"mt-3 text-2xl font-semibold"},ze={class:"text-xs text-muted-foreground"},Fe={class:"mt-2 whitespace-pre-line"},je={class:"mt-2 whitespace-pre-line"},qe={key:1,class:"text-sm text-muted-foreground"},Ge={class:"flex gap-2"},at=ce({__name:"simulation",setup(Je){const{$api:w}=fe(),L=b(50),g=b(""),p=b([]),k=b(null),m=b(!1),x=b(!1),i=b(!1),y=b(null),C=b(null),A=b(!1),N=[{label:"杀猪盘 / 感情投资",value:"pig-butchering"},{label:"钓鱼链接 / 伪装客服",value:"phishing"},{label:"冒充公检法",value:"fake-customer-service"},{label:"投资理财骗局",value:"investment"},{label:"借贷与刷单",value:"loan"}],D=[{label:"入门",value:"easy"},{label:"进阶",value:"medium"},{label:"挑战",value:"hard"}],H=[{label:"混合博弈（提问 + 引诱）",value:"mixed"},{label:"纯诈骗话术",value:"pure_fake"}],o=me({type:N[0].value,difficulty:D[1].value,mode:H[0].value}),_=W(()=>y.value??C.value),O=W(()=>_.value?.capabilityProfile??null),R=()=>{k.value&&(k.value.scrollTop=k.value.scrollHeight)},T=t=>{window.alert(t)},U=(t,e)=>{const d=t?.response?.data;return typeof d=="string"&&d.trim()?d:d?.message?Array.isArray(d.message)?d.message[0]:d.message:d?.detail?Array.isArray(d.detail)?d.detail[0]:d.detail:e},z=t=>({scenarioType:t.scenario_type??o.type,difficulty:t.difficulty??o.difficulty,mode:t.mode??o.mode,finalScore:t.final_score??0,conversationRounds:t.conversation_rounds??0,endReasonLabel:t.end_reason_label??"系统结束",performanceAnalysis:t.performance_analysis??"",suggestions:t.suggestions??"",updatedAt:t.updated_at??new Date().toISOString(),capabilityProfile:t.capability_profile??void 0}),F=t=>{i.value=!0;const e=z(t);L.value=e.finalScore,y.value=e,C.value=e},j=async()=>{A.value=!0;try{const{data:t}=await w.get("/chat/latest-result/");t.has_result?C.value=z(t.data):C.value=null}catch(t){console.warn("fetch latest result failed",t)}finally{A.value=!1}},X=async()=>{const t=g.value.trim();if(!t||m.value)return;if(i.value){T("当前会话已结束，请重新开始。");return}m.value=!0;const e=p.value.map(u=>({role:u.role,content:u.content}));e.push({role:"user",content:t}),p.value.push({role:"user",content:t}),g.value="";try{const{data:u}=await w.post("/chat/scenario/stateless/",{message:t,scenario_type:o.type,difficulty:o.difficulty,mode:o.mode,history:e,current_score:L.value});p.value.push({role:"assistant",content:u.response||"AI 暂无回复，请稍后再试。"}),u.session_closed&&F(u)}catch(u){T(U(u,"发送失败，请稍后重试"))}finally{m.value=!1,V(R)}},Y=async()=>{if(!(!p.value.length||i.value||m.value)){m.value=!0,x.value=!0;try{const t=p.value.map(u=>({role:u.role,content:u.content})),{data:e}=await w.post("/chat/scenario/stateless/",{force_end:!0,scenario_type:o.type,difficulty:o.difficulty,mode:o.mode,history:t,current_score:L.value});e.response&&p.value.push({role:"assistant",content:e.response}),e.session_closed&&F(e)}catch(t){T(U(t,"结束失败，请稍后再试"))}finally{m.value=!1,x.value=!1,V(R)}}},q=async()=>{if(!m.value)try{await w.post("/chat/scenario/stateless/",{reset:!0,scenario_type:o.type,difficulty:o.difficulty,mode:o.mode})}catch(t){console.warn("reset session failed",t)}finally{p.value=[],g.value="",i.value=!1,y.value=null,m.value=!1,x.value=!1,V(R)}};return ve(j),pe(p,()=>V(R),{deep:!0}),(t,e)=>{const u=te,d=ae,G=oe,J=le,B=re,Z=ue,I=de,h=ie,K=ne,Q=se;return c(),v("div",he,[l(u,{title:"AI 场景模拟",description:"选择高发诈骗场景，与 AI 角色进行多轮对练，及时总结识别要点。"}),l(Q,{class:"border border-border/80"},{default:n(()=>[l(J,null,{default:n(()=>[l(d,null,{default:n(()=>[...e[4]||(e[4]=[f("对话操作台",-1)])]),_:1}),l(G,null,{default:n(()=>[...e[5]||(e[5]=[f("配置场景与模式，AI 将模拟真实话术与你交互。",-1)])]),_:1})]),_:1}),l(K,{class:"space-y-4"},{default:n(()=>[s("div",we,[s("div",null,[l(B,null,{default:n(()=>[...e[6]||(e[6]=[f("场景",-1)])]),_:1}),E(s("select",{"onUpdate:modelValue":e[0]||(e[0]=a=>o.type=a),class:"w-full rounded-md border border-border bg-background p-2 text-sm",disabled:i.value},[(c(),v(S,null,$(N,a=>s("option",{key:a.value,value:a.value},r(a.label),9,Ce)),64))],8,ke),[[M,o.type]])]),s("div",null,[l(B,null,{default:n(()=>[...e[7]||(e[7]=[f("难度",-1)])]),_:1}),E(s("select",{"onUpdate:modelValue":e[1]||(e[1]=a=>o.difficulty=a),class:"w-full rounded-md border border-border bg-background p-2 text-sm",disabled:i.value},[(c(),v(S,null,$(D,a=>s("option",{key:a.value,value:a.value},r(a.label),9,Re)),64))],8,Ae),[[M,o.difficulty]])]),s("div",null,[l(B,null,{default:n(()=>[...e[8]||(e[8]=[f("模式",-1)])]),_:1}),E(s("select",{"onUpdate:modelValue":e[2]||(e[2]=a=>o.mode=a),class:"w-full rounded-md border border-border bg-background p-2 text-sm",disabled:i.value},[(c(),v(S,null,$(H,a=>s("option",{key:a.value,value:a.value},r(a.label),9,$e)),64))],8,Se),[[M,o.mode]])])]),s("div",Ve,[s("div",Le,[e[10]||(e[10]=s("p",{class:"font-medium"},"对话得分进度",-1)),i.value&&y.value?(c(),v("div",Te,[s("p",Be,[f(r(y.value.finalScore),1),e[9]||(e[9]=s("span",{class:"text-base font-normal"}," / 100",-1))]),s("p",Ie,r(y.value.endReasonLabel),1)])):(c(),v("p",Pe,"完成演练后将显示本次综合得分"))]),s("div",Ee,[s("div",{class:"h-2 rounded-full bg-foreground transition-all",style:_e({width:i.value&&y.value?y.value.finalScore+"%":"0%"})},null,4)])]),s("div",{ref_key:"chatBodyRef",ref:k,class:"max-h-[420px] space-y-3 overflow-y-auto rounded-2xl border border-border/70 bg-background/80 p-4 shadow-inner"},[(c(!0),v(S,null,$(p.value,(a,ee)=>(c(),v("div",{key:ee,class:be(["max-w-[80%] rounded-2xl px-4 py-2 text-sm leading-relaxed",a.role==="user"?"ml-auto bg-foreground text-background":"bg-secondary text-foreground"])},r(a.content),3))),128)),p.value.length?P("",!0):(c(),v("p",Me," 还没有任何消息，先向 AI 发起第一句对话吧。 "))],512),s("form",{class:"flex flex-col gap-3 md:flex-row",onSubmit:ye(X,["prevent"])},[l(Z,{modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=a=>g.value=a),rows:"3",class:"flex-1",disabled:i.value,placeholder:"描述你的想法、疑问或进一步追问，以锻炼甄别与拒绝能力。"},null,8,["modelValue","disabled"]),s("div",Ne,[l(h,{type:"submit",class:"gap-2",disabled:m.value||!g.value.trim()||i.value},{default:n(()=>[l(I,{name:"lucide:message-circle",class:"h-4 w-4"}),f(" "+r(m.value&&!x.value?"发送中...":"发送"),1)]),_:1},8,["disabled"]),l(h,{type:"button",variant:"outline",disabled:m.value,onClick:q},{default:n(()=>[...e[11]||(e[11]=[f(" 重置会话 ",-1)])]),_:1},8,["disabled"]),l(h,{type:"button",variant:"secondary",disabled:i.value||!p.value.length||m.value,onClick:Y},{default:n(()=>[l(I,{name:"lucide:flag",class:"h-4 w-4"}),f(" "+r(x.value?"结算中...":"提前结束"),1)]),_:1},8,["disabled"])])],32),i.value?(c(),v("p",De," 本次演练已结束："+r(y.value?.endReasonLabel??"系统终止")+"，可以重置后开启新的对话。 ",1)):P("",!0)]),_:1})]),_:1}),l(Q,null,{default:n(()=>[l(J,null,{default:n(()=>[l(d,null,{default:n(()=>[...e[12]||(e[12]=[f("对话总结",-1)])]),_:1}),l(G,null,{default:n(()=>[...e[13]||(e[13]=[f("系统自动保存最近一次完整演练，便于复盘与分享。",-1)])]),_:1})]),_:1}),l(K,{class:"space-y-4"},{default:n(()=>[_.value?(c(),v("div",He,[s("div",Oe,[s("span",null,r(_.value.scenarioType)+" · "+r(_.value.difficulty)+" · "+r(_.value.mode),1),s("span",null,"轮次 "+r(_.value.conversationRounds),1)]),s("p",Ue,r(_.value.finalScore)+" / 100",1),s("p",ze,r(_.value.endReasonLabel),1),O.value?(c(),ge(xe,{key:0,class:"mt-4 w-full",profile:O.value,height:"240px"},null,8,["profile"])):P("",!0),e[14]||(e[14]=s("p",{class:"mt-4 text-xs uppercase tracking-widest text-muted-foreground"},"表现分析",-1)),s("p",Fe,r(_.value.performanceAnalysis),1),e[15]||(e[15]=s("p",{class:"mt-4 text-xs uppercase tracking-widest text-muted-foreground"},"改进建议",-1)),s("p",je,r(_.value.suggestions),1)])):(c(),v("p",qe,"暂无总结，完成一次演练后即可查看详细复盘。")),s("div",Ge,[l(h,{variant:"outline",disabled:A.value,onClick:j},{default:n(()=>[l(I,{name:"lucide:refresh-ccw",class:"h-4 w-4"}),f(" "+r(A.value?"刷新中...":"刷新最近记录"),1)]),_:1},8,["disabled"]),l(h,{variant:"secondary",onClick:q},{default:n(()=>[...e[16]||(e[16]=[f("重新开始",-1)])]),_:1})])]),_:1})]),_:1})])}}});export{at as default};
