import{_ as O}from"./38tOet_I.js";import{d as ce,_ as fe,a as ye,b as pe,c as ve}from"./Bnx0PPvk.js";import{_ as Q}from"./DzNSn88N.js";import{_ as X}from"./CCRcQfJ_.js";import{_ as _e}from"./D3KgOzdW.js";import{_ as be}from"./BgC2Tqll.js";import{_ as ge}from"./C3Ar38eF.js";import{_ as Y}from"./BtdkqM2g.js";import{g as Z,r as v,c as i,o as l,q as b,a as r,b as s,v as t,J as H,w as a,d as u,t as m,H as ee,E as te,F as S,s as j,p as E,a1 as he,k as xe,j as we,l as ke,C as $e,n as Ce,N as K,x as Ve,A as Le,z as De}from"./C4cmwJeW.js";import"./CTtaAHph.js";const Ae={class:"rounded-lg border border-border/70 p-4 text-sm relative"},Ne={class:"flex items-start justify-between"},Te={class:"mt-1 text-xs text-muted-foreground"},ze={class:"mt-3 whitespace-pre-line text-foreground"},Ee={class:"mt-3 flex items-center gap-3 text-xs text-muted-foreground"},Se=["disabled"],je={key:1,class:"mt-3 space-y-2"},Be={key:0,class:"rounded-md border border-dashed border-border/70 p-2 text-xs"},Fe={key:1,class:"space-y-2"},Re={class:"flex justify-end"},qe={key:2,class:"mt-4 space-y-3 relative"},Ue={key:1},oe=Z({name:"CommentThread",__name:"CommentThread",props:{comment:{},onLike:{type:Function},onReply:{type:Function},onDelete:{type:Function},formatDate:{type:Function},auth:{},depth:{}},setup(d){const p=d,y=v(!1),g=v(""),_=v(!1),o=v(!1),h=v(!1),k=()=>{o.value=!o.value},$=()=>{y.value=!y.value,y.value||(g.value="")},A=async()=>{if(!(!p.auth.isAuthenticated||!g.value.trim())){_.value=!0;try{await p.onReply(p.comment.id,g.value),g.value="",y.value=!1}finally{_.value=!1}}},N=async()=>{_.value=!0;try{await p.onLike(p.comment.id)}finally{_.value=!1}},V=async()=>{if(!(!p.onDelete||h.value)){h.value=!0;try{await p.onDelete(p.comment.id)}finally{h.value=!1}}};return(T,C)=>{const c=Q,x=O,B=Y,F=X,R=oe;return l(),i("div",Ae,[d.comment.replies?.length?(l(),i("button",{key:0,class:"absolute left-0 top-0 h-full w-4 flex items-center justify-center text-muted-foreground hover:text-foreground",onClick:k},[s(c,{name:t(o)?"lucide:plus":"lucide:minus",class:"h-4 w-4"},null,8,["name"])])):b("",!0),r("div",{style:H({"margin-left":`${d.comment.replies?.length?1.5:0}rem`})},[r("div",Ne,[r("div",null,[s(x,{to:`/users/${d.comment.author.username}`,class:"font-medium hover:underline"},{default:a(()=>[u(m(d.comment.author.nickname||d.comment.author.username),1)]),_:1},8,["to"]),r("p",Te,m(d.formatDate(d.comment.created_at)),1)]),r("button",{class:ee(["flex items-center gap-1 text-xs",d.comment.is_liked?"text-primary":"text-muted-foreground"]),onClick:N},[s(c,{name:d.comment.is_liked?"lucide:heart":"lucide:heart-off",class:"h-4 w-4"},null,8,["name"]),r("span",null,m(d.comment.like_count),1)],2)]),r("p",ze,m(d.comment.body),1),r("div",Ee,[r("button",{class:"hover:text-foreground",onClick:$},m(t(y)?"取消回复":"回复"),1),d.comment.can_moderate?(l(),i("button",{key:0,class:"hover:text-destructive disabled:opacity-50",disabled:t(h),onClick:V},m(t(h)?"删除中...":"删除"),9,Se)):b("",!0)])],4),t(y)?(l(),i("div",je,[d.auth.isAuthenticated?(l(),i("div",Fe,[s(B,{modelValue:t(g),"onUpdate:modelValue":C[0]||(C[0]=L=>te(g)?g.value=L:null),rows:"3",placeholder:"填写回复内容"},null,8,["modelValue"]),r("div",Re,[s(F,{size:"sm",disabled:t(_),onClick:A},{default:a(()=>[u(m(t(_)?"提交中…":"回复"),1)]),_:1},8,["disabled"])])])):(l(),i("p",Be," 登录后才能回复。 "))])):b("",!0),d.comment.replies?.length?(l(),i("div",qe,[p.depth>0?(l(),i("div",{key:0,class:"absolute left-0 top-0 h-full w-0.5 bg-border",style:H({"margin-left":`${(p.depth-1)*1.5}rem`})},null,4)):b("",!0),r("div",{style:H({"padding-left":`${p.depth*1.5}rem`})},[d.comment.replies.length>3?(l(),i("button",{key:0,class:"text-xs text-muted-foreground hover:text-foreground",onClick:k},m(t(o)?`展开 ${d.comment.replies.length} 条回复`:"收起回复"),1)):b("",!0),t(o)?b("",!0):(l(),i("div",Ue,[(l(!0),i(S,null,j(d.comment.replies,L=>(l(),E(R,{key:L.id,comment:L,"on-like":d.onLike,"on-reply":d.onReply,"format-date":d.formatDate,auth:d.auth,depth:p.depth+1},null,8,["comment","on-like","on-reply","format-date","auth","depth"]))),128))]))],4)])):b("",!0)])}}}),Me={class:"space-y-6"},Ie={key:0,class:"space-y-6"},Pe={class:"flex items-center justify-between text-xs text-muted-foreground"},He={class:"whitespace-pre-line text-sm leading-relaxed"},Je={key:0,class:"grid gap-3 md:grid-cols-2"},We=["src"],Ge={class:"flex items-center gap-4"},Ke={class:"flex items-center gap-1"},Oe={class:"flex flex-wrap items-center gap-2"},Qe=["disabled"],Xe=["value"],Ye={class:"flex flex-wrap items-center gap-2"},Ze={key:0,class:"rounded-lg border border-dashed border-border/70 p-4 text-sm text-muted-foreground"},et={class:"flex justify-end"},tt={class:"space-y-4"},ot={key:0,class:"rounded-lg border border-dashed border-border/70 p-6 text-sm text-muted-foreground"},nt={key:1,class:"rounded-lg border border-dashed border-border/70 p-6 text-sm text-muted-foreground"},st={key:2,class:"space-y-4"},at={key:1,class:"rounded-lg border border-dashed border-border/70 p-6 text-sm text-muted-foreground"},vt=Z({__name:"[id]",setup(d){const p=he(),{$api:y,$config:g}=xe(),_=we(),o=v(null),h=v(!0),k=v(!1),$=v(""),A=v([]),N=v(!1),V=v(!1),T=v(!1),C=v(!1),c=ke({title:"",body:"",community:""}),x=async()=>{h.value=!0;try{const{data:n}=await y.get(`/community/posts/${p.params.id}/`);o.value=n}catch(n){console.error("加载帖子失败",n),o.value=null}finally{h.value=!1}},B=async()=>{N.value=!0;try{const{data:n}=await y.get("/community/communities/",{params:{page_size:100}});A.value=Array.isArray(n)?n:n.results||[]}catch(n){console.error("加载社区列表失败",n)}finally{N.value=!1}},F=async()=>{if(o.value){k.value=!0;try{await y.post("/community/comments/",{post:o.value.id,body:$.value}),$.value="",await x()}catch(n){console.error("发布评论失败",n);const e=n;window.alert(e.response?.data?.detail||"发布失败，请稍后重试")}finally{k.value=!1}}},R=async(n,e)=>{if(o.value)try{await y.post("/community/comments/",{post:o.value.id,parent:n,body:e}),await x()}catch(w){console.error("回复失败",w);const z=w;window.alert(z.response?.data?.detail||"回复失败，请稍后重试")}},L=async n=>{if(!_.isAuthenticated){window.alert("请先登录后再点赞评论");return}try{await y.post(`/community/comments/${n}/like/`),await x()}catch(e){console.error("评论点赞失败",e),window.alert("操作失败，请稍后重试")}},ne=async()=>{if(!_.isAuthenticated){window.alert("请先登录后再点赞");return}if(o.value)try{const{data:n}=await y.post(`/community/posts/${o.value.id}/like/`);o.value.is_liked=!!n?.liked,typeof n?.like_count=="number"&&(o.value.like_count=n.like_count)}catch(n){console.error("点赞失败",n)}},se=()=>{o.value&&(c.title=o.value.title,c.body=o.value.body,c.community=String(o.value.community_detail.id),V.value=!0)},ae=()=>{V.value=!1},le=async()=>{if(o.value){if(!c.title.trim()||!c.body.trim()){window.alert("标题和内容不能为空");return}if(!c.community){window.alert("请选择要移动到的社区");return}T.value=!0;try{await y.patch(`/community/posts/${o.value.id}/`,{title:c.title,body:c.body,community:Number(c.community)}),V.value=!1,await x(),window.alert("帖子已更新")}catch(n){console.error("更新帖子失败",n);const e=n;window.alert(e.response?.data?.detail||"更新失败，请稍后重试")}finally{T.value=!1}}},re=async()=>{if(o.value&&window.confirm("确定删除该帖子吗？删除后将无法恢复。")){C.value=!0;try{await y.delete(`/community/posts/${o.value.id}/`),window.alert("帖子已删除"),K("/community")}catch(n){console.error("删除帖子失败",n),window.alert("删除失败，请稍后重试")}finally{C.value=!1}}},ie=async n=>{if(!_.isAuthenticated){window.alert("请先登录后再操作");return}if(window.confirm("确定删除该评论吗？"))try{await y.delete(`/community/comments/${n}/`),await x()}catch(e){console.error("删除评论失败",e);const w=e;window.alert(w.response?.data?.detail||"删除失败，请稍后重试")}},de=n=>n?n.startsWith("http")?n:`${g.public.apiBase?.replace(/\/$/,"")??""}${n}`:"",J=n=>{try{return new Date(n).toLocaleString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return n}};return $e(()=>p.params.id,async()=>{await x()},{immediate:!0}),Ce(()=>{B()}),(n,e)=>{const w=O,z=ye,q=pe,U=fe,M=ve,W=Q,D=X,ue=_e,I=ce,P=be,me=ge,G=Y;return l(),i("div",Me,[t(o)?(l(),i("div",Ie,[s(I,{class:"border border-border/70"},{default:a(()=>[s(U,{class:"space-y-2"},{default:a(()=>[r("div",Pe,[s(w,{to:`/community/${t(o).community_detail.slug}`,class:"font-medium text-foreground hover:underline"},{default:a(()=>[u(m(t(o).community_detail.name),1)]),_:1},8,["to"]),r("span",null,m(J(t(o).created_at)),1)]),s(z,{class:"text-2xl"},{default:a(()=>[u(m(t(o).title),1)]),_:1}),s(q,null,{default:a(()=>[s(w,{to:`/users/${t(o).author.username}`,class:"font-medium text-foreground hover:underline"},{default:a(()=>[u(m(t(o).author.nickname||t(o).author.username),1)]),_:1},8,["to"]),e[5]||(e[5]=u(" 发布 ",-1))]),_:1})]),_:1}),s(M,{class:"space-y-4"},{default:a(()=>[r("p",He,m(t(o).body),1),t(o).images.length?(l(),i("div",Je,[(l(!0),i(S,null,j(t(o).images,f=>(l(),i("img",{key:f.id,src:de(f.image),class:"h-64 w-full rounded-lg object-cover"},null,8,We))),128))])):b("",!0)]),_:1}),s(ue,{class:"flex flex-wrap items-center justify-between gap-3 text-sm text-muted-foreground"},{default:a(()=>[r("div",Ge,[r("button",{class:ee(["flex items-center gap-1",t(o).is_liked?"text-primary":""]),onClick:ne},[s(W,{name:t(o).is_liked?"lucide:heart":"lucide:heart-off",class:"h-4 w-4"},null,8,["name"]),r("span",null,m(t(o).like_count),1)],2),r("div",Ke,[s(W,{name:"lucide:message-square",class:"h-4 w-4"}),r("span",null,m(t(o).comment_count),1)])]),r("div",Oe,[s(D,{variant:"ghost",size:"sm",onClick:e[0]||(e[0]=f=>("navigateTo"in n?n.navigateTo:t(K))(`/community/${t(o).community_detail.slug}`))},{default:a(()=>[...e[6]||(e[6]=[u(" 返回社区 ",-1)])]),_:1}),t(o).can_moderate?(l(),E(D,{key:0,variant:"outline",size:"sm",onClick:se},{default:a(()=>[...e[7]||(e[7]=[u(" 编辑 / 移动 ",-1)])]),_:1})):b("",!0),t(o).can_moderate?(l(),E(D,{key:1,variant:"destructive",size:"sm",disabled:t(C),onClick:re},{default:a(()=>[u(m(t(C)?"删除中...":"删除帖子"),1)]),_:1},8,["disabled"])):b("",!0)])]),_:1})]),_:1}),t(V)?(l(),E(I,{key:0,class:"border border-border/70"},{default:a(()=>[s(U,null,{default:a(()=>[s(z,null,{default:a(()=>[...e[8]||(e[8]=[u("编辑 / 移动帖子",-1)])]),_:1}),s(q,null,{default:a(()=>[...e[9]||(e[9]=[u("更新帖子内容或调整所属社区。",-1)])]),_:1})]),_:1}),s(M,{class:"space-y-4"},{default:a(()=>[r("div",null,[s(P,{for:"edit-community"},{default:a(()=>[...e[10]||(e[10]=[u("选择社区",-1)])]),_:1}),Ve(r("select",{id:"edit-community","onUpdate:modelValue":e[1]||(e[1]=f=>t(c).community=f),class:"mt-1 w-full rounded-md border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary",disabled:t(N)||!t(A).length,required:""},[e[11]||(e[11]=r("option",{value:"",disabled:""},"请选择社区",-1)),(l(!0),i(S,null,j(t(A),f=>(l(),i("option",{key:f.id,value:String(f.id)},m(f.name),9,Xe))),128))],8,Qe),[[Le,t(c).community]])]),r("div",null,[s(P,{for:"edit-title"},{default:a(()=>[...e[12]||(e[12]=[u("标题",-1)])]),_:1}),s(me,{id:"edit-title",modelValue:t(c).title,"onUpdate:modelValue":e[2]||(e[2]=f=>t(c).title=f),required:""},null,8,["modelValue"])]),r("div",null,[s(P,{for:"edit-body"},{default:a(()=>[...e[13]||(e[13]=[u("内容",-1)])]),_:1}),s(G,{id:"edit-body",modelValue:t(c).body,"onUpdate:modelValue":e[3]||(e[3]=f=>t(c).body=f),rows:"4",required:""},null,8,["modelValue"])]),r("div",Ye,[s(D,{disabled:t(T),type:"button",onClick:le},{default:a(()=>[u(m(t(T)?"保存中...":"保存修改"),1)]),_:1},8,["disabled"]),s(D,{type:"button",variant:"ghost",onClick:ae},{default:a(()=>[...e[14]||(e[14]=[u("取消",-1)])]),_:1})])]),_:1})]),_:1})):b("",!0),s(I,{class:"border border-border/70"},{default:a(()=>[s(U,null,{default:a(()=>[s(z,null,{default:a(()=>[...e[15]||(e[15]=[u("发表评论",-1)])]),_:1}),s(q,null,{default:a(()=>[...e[16]||(e[16]=[u("保持友善、理性和务实的讨论氛围",-1)])]),_:1})]),_:1}),s(M,null,{default:a(()=>[t(_).isAuthenticated?(l(),i("form",{key:1,class:"space-y-4",onSubmit:De(F,["prevent"])},[s(G,{modelValue:t($),"onUpdate:modelValue":e[4]||(e[4]=f=>te($)?$.value=f:null),rows:"4",placeholder:"分享你的见解或补充案例",required:""},null,8,["modelValue"]),r("div",et,[s(D,{type:"submit",disabled:t(k)},{default:a(()=>[u(m(t(k)?"提交中…":"发布评论"),1)]),_:1},8,["disabled"])])],32)):(l(),i("div",Ze,[e[18]||(e[18]=u(" 登录后即可发表评论。",-1)),s(w,{to:"/login",class:"ml-1 text-foreground hover:underline"},{default:a(()=>[...e[17]||(e[17]=[u("前往登录",-1)])]),_:1})]))]),_:1})]),_:1}),r("section",tt,[e[19]||(e[19]=r("h2",{class:"text-lg font-semibold"},"全部评论",-1)),t(h)?(l(),i("div",ot," 正在加载评论… ")):t(o).comments?.length?(l(),i("div",st,[(l(!0),i(S,null,j(t(o).comments,f=>(l(),E(oe,{key:f.id,comment:f,"on-like":L,"on-reply":R,"on-delete":ie,"format-date":J,auth:t(_),depth:0},null,8,["comment","auth"]))),128))])):(l(),i("div",nt," 暂无评论，欢迎抢先留言。 "))])])):(l(),i("div",at," 正在加载帖子… "))])}}});export{vt as default};
