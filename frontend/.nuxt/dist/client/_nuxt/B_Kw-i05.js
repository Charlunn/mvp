import{_ as se}from"./DzNSn88N.js";import{_ as oe}from"./DLa9Lqb7.js";import{_ as re}from"./CCRcQfJ_.js";import{_ as ae}from"./38tOet_I.js";import{d as le,_ as ne,a as ie,b as de,c as ue}from"./Bnx0PPvk.js";import{_ as me}from"./BgC2Tqll.js";import{_ as ce}from"./C3Ar38eF.js";import{_ as fe}from"./BtdkqM2g.js";import{_ as _e}from"./D3KgOzdW.js";import{g as pe,a1 as ge,j as ye,k as be,r as b,l as xe,m as H,C as ve,c,a,v as t,t as i,q as w,p as k,b as s,d as l,w as o,F as I,s as U,o as d,z as we,H as ke,N as he}from"./C4cmwJeW.js";import"./CTtaAHph.js";const Ce={class:"space-y-6"},$e={class:"rounded-2xl border border-border/70 bg-secondary/30 p-6"},Be={key:0,class:"space-y-4"},Ve={class:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between"},je={class:"text-2xl font-semibold"},Ae={class:"mt-1 max-w-2xl text-sm text-muted-foreground"},Le={class:"flex flex-wrap items-center gap-3 text-sm text-muted-foreground"},Ne={class:"inline-flex items-center gap-1 rounded-full border border-border px-3 py-1"},Te={key:0,class:"inline-flex items-center gap-1 rounded-full border border-border px-3 py-1"},De={class:"flex flex-wrap items-center gap-3"},Fe={key:1,class:"text-sm text-muted-foreground"},Me={class:"grid gap-6 lg:grid-cols-[2fr_1fr]"},ze={class:"space-y-4"},Se={key:0,class:"mt-2 text-xs text-muted-foreground"},qe={class:"flex justify-end"},Pe={class:"space-y-4"},Ee={class:"flex items-center justify-between"},He={key:0,class:"rounded-lg border border-dashed border-border/70 p-6 text-sm text-muted-foreground"},Ie={key:1,class:"rounded-lg border border-dashed border-border/70 p-6 text-sm text-muted-foreground"},Ue={key:2,class:"space-y-4"},Re={class:"whitespace-pre-line text-sm leading-relaxed"},We={key:0,class:"grid gap-3 md:grid-cols-2"},Ge=["src"],Je={class:"flex items-center gap-4"},Ke=["onClick"],Oe={class:"flex items-center gap-1"},Qe={key:0,class:"flex justify-center"},Xe={class:"space-y-4"},ut=pe({__name:"[slug]",setup(Ye){const h=ge(),D=ye(),{$api:x,$config:R}=be(),u=b(null),_=b(!1),p=b(!1),g=b([]),F=b(!1),S=b(1),A=b(!1),m=xe({title:"",body:"",images:[]}),L=H(()=>!!u.value?.current_role),W=H(()=>u.value?.is_private&&!L.value?"加入社区后即可查看全部帖子":"暂无帖子，快来发布第一条内容吧"),M=async()=>{try{const{data:r}=await x.get(`/community/communities/${h.params.slug}/`);u.value=r}catch(r){console.error("加载社区详情失败",r),u.value=null}},v=async(r=1,e=!1)=>{p.value=!0;try{const{data:f}=await x.get("/community/posts/",{params:{community:h.params.slug,page:r}}),N=Array.isArray(f)?f:f.results||[];e?g.value=[...g.value,...N]:g.value=N,F.value=!!f?.next,S.value=r}catch(f){console.error("加载社区帖子失败",f),e||(g.value=[])}finally{p.value=!1}},q=async()=>{if(!D.isAuthenticated){window.alert("请先登录后再加入社区");return}_.value=!0;try{await x.post(`/community/communities/${h.params.slug}/join/`),await M(),await v(),window.alert("已加入社区")}catch(r){console.error("加入社区失败",r),window.alert("加入失败，请稍后重试")}finally{_.value=!1}},G=async()=>{_.value=!0;try{await x.post(`/community/communities/${h.params.slug}/leave/`),await M(),await v(),window.alert("已退出社区")}catch(r){console.error("退出社区失败",r),window.alert("退出失败，请稍后重试")}finally{_.value=!1}},J=r=>{const e=r.target;m.images=Array.from(e.files??[])},K=async()=>{if(!(!m.title.trim()||!m.body.trim())){A.value=!0;try{const r=new FormData;r.append("community",String(u.value?.id??"")),r.append("title",m.title),r.append("body",m.body),m.images.forEach(e=>r.append("images",e)),await x.post("/community/posts/",r,{headers:{"Content-Type":"multipart/form-data"}}),m.title="",m.body="",m.images=[],await v(),window.alert("帖子已发布")}catch(r){console.error("发布帖子失败",r);const e=r;window.alert(e.response?.data?.detail||"发布失败，请稍后重试")}finally{A.value=!1}}},O=async r=>{if(!D.isAuthenticated){window.alert("请先登录后再点赞");return}try{const{data:e}=await x.post(`/community/posts/${r.id}/like/`);r.is_liked=!!e?.liked,typeof e?.like_count=="number"&&(r.like_count=e.like_count)}catch(e){console.error("点赞失败",e)}},Q=()=>{!F.value||p.value||v(S.value+1,!0)},X=()=>v(1,!1),Y=r=>r?r.startsWith("http")?r:`${R.public.apiBase?.replace(/\/$/,"")??""}${r}`:"",P=r=>{if(!r)return"-";try{return new Date(r).toLocaleString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return r}};return ve(()=>h.params.slug,async()=>{await M(),await v()},{immediate:!0}),(r,e)=>{const f=se,N=oe,y=re,E=ae,C=ie,$=de,B=ne,z=me,Z=ce,ee=fe,V=ue,j=le,te=_e;return d(),c("div",Ce,[a("div",$e,[t(u)?(d(),c("div",Be,[a("div",Ve,[a("div",null,[a("h1",je,i(t(u).name),1),a("p",Ae,i(t(u).description||"这个社区还没有简介。"),1)]),a("div",Le,[a("span",Ne,[s(f,{name:"lucide:users",class:"h-4 w-4"}),l(" "+i(t(u).members_count)+" 名成员 ",1)]),t(u).is_private?(d(),c("span",Te,[s(f,{name:"lucide:lock",class:"h-4 w-4"}),e[2]||(e[2]=l(" 私密社区 ",-1))])):w("",!0),t(u).current_role==="moderator"?(d(),k(N,{key:1,variant:"outline"},{default:o(()=>[...e[3]||(e[3]=[l("社区管理员",-1)])]),_:1})):w("",!0)])]),a("div",De,[t(L)?(d(),k(y,{key:1,variant:"outline",disabled:t(_),onClick:G},{default:o(()=>[l(i(t(_)?"处理中…":"退出社区"),1)]),_:1},8,["disabled"])):(d(),k(y,{key:0,disabled:t(_),onClick:q},{default:o(()=>[l(i(t(_)?"处理中…":"加入社区"),1)]),_:1},8,["disabled"])),s(E,{to:"/community",class:"text-sm text-muted-foreground hover:text-foreground"},{default:o(()=>[...e[4]||(e[4]=[l(" 返回社区广场 ",-1)])]),_:1})])])):(d(),c("div",Fe,"正在加载社区信息…"))]),a("section",Me,[a("div",ze,[t(D).isAuthenticated&&t(L)?(d(),k(j,{key:0,class:"border border-border/70"},{default:o(()=>[s(B,null,{default:o(()=>[s(C,null,{default:o(()=>[...e[5]||(e[5]=[l("分享新帖子",-1)])]),_:1}),s($,null,{default:o(()=>[...e[6]||(e[6]=[l("与社区成员交流实战经验",-1)])]),_:1})]),_:1}),s(V,null,{default:o(()=>[a("form",{class:"space-y-4",onSubmit:we(K,["prevent"])},[a("div",null,[s(z,{for:"title"},{default:o(()=>[...e[7]||(e[7]=[l("标题",-1)])]),_:1}),s(Z,{id:"title",modelValue:t(m).title,"onUpdate:modelValue":e[0]||(e[0]=n=>t(m).title=n),placeholder:"一句话概括你的观点",required:""},null,8,["modelValue"])]),a("div",null,[s(z,{for:"body"},{default:o(()=>[...e[8]||(e[8]=[l("内容",-1)])]),_:1}),s(ee,{id:"body",modelValue:t(m).body,"onUpdate:modelValue":e[1]||(e[1]=n=>t(m).body=n),rows:"4",placeholder:"详细描述你的案例或问题",required:""},null,8,["modelValue"])]),a("div",null,[s(z,{class:"mb-1 block text-sm font-medium text-muted-foreground"},{default:o(()=>[...e[9]||(e[9]=[l("上传图片（可选）",-1)])]),_:1}),a("input",{type:"file",multiple:"",accept:"image/*",class:"w-full text-sm",onChange:J},null,32),t(m).images.length?(d(),c("p",Se,"已选择 "+i(t(m).images.length)+" 张图片",1)):w("",!0)]),a("div",qe,[s(y,{type:"submit",disabled:t(A)},{default:o(()=>[l(i(t(A)?"发布中…":"发布"),1)]),_:1},8,["disabled"])])],32)]),_:1})]),_:1})):t(u)&&t(u).is_private&&!t(L)?(d(),k(j,{key:1,class:"border border-dashed border-border/70 bg-muted/20"},{default:o(()=>[s(B,null,{default:o(()=>[s(C,null,{default:o(()=>[...e[10]||(e[10]=[l("加入后查看讨论",-1)])]),_:1}),s($,null,{default:o(()=>[...e[11]||(e[11]=[l("这是一个私密社区，成员加入后可访问全部内容",-1)])]),_:1})]),_:1}),s(V,null,{default:o(()=>[s(y,{class:"w-full",disabled:t(_),onClick:q},{default:o(()=>[...e[12]||(e[12]=[l("申请加入",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})):w("",!0),a("div",Pe,[a("div",Ee,[e[14]||(e[14]=a("h2",{class:"text-lg font-semibold"},"社区动态",-1)),s(y,{variant:"outline",size:"sm",disabled:t(p),onClick:X},{default:o(()=>[s(f,{name:"lucide:refresh-cw",class:"mr-1 h-4 w-4"}),e[13]||(e[13]=l("刷新 ",-1))]),_:1},8,["disabled"])]),t(p)&&!t(g).length?(d(),c("div",He," 正在加载帖子… ")):t(g).length?(d(),c("div",Ue,[(d(!0),c(I,null,U(t(g),n=>(d(),k(j,{key:n.id,class:"border border-border/70"},{default:o(()=>[s(B,null,{default:o(()=>[s(C,{class:"text-xl"},{default:o(()=>[l(i(n.title),1)]),_:2},1024),s($,null,{default:o(()=>[s(E,{to:`/users/${n.author.username}`,class:"font-medium hover:underline"},{default:o(()=>[l(i(n.author.nickname||n.author.username),1)]),_:2},1032,["to"]),l(" · "+i(P(n.created_at)),1)]),_:2},1024)]),_:2},1024),s(V,{class:"space-y-4"},{default:o(()=>[a("p",Re,i(n.body),1),n.images.length?(d(),c("div",We,[(d(!0),c(I,null,U(n.images,T=>(d(),c("img",{key:T.id,src:Y(T.image),class:"h-48 w-full rounded-lg object-cover"},null,8,Ge))),128))])):w("",!0)]),_:2},1024),s(te,{class:"flex items-center justify-between text-sm text-muted-foreground"},{default:o(()=>[a("div",Je,[a("button",{class:ke(["flex items-center gap-1",n.is_liked?"text-primary":""]),onClick:T=>O(n)},[s(f,{name:n.is_liked?"lucide:heart":"lucide:heart-off",class:"h-4 w-4"},null,8,["name"]),a("span",null,i(n.like_count),1)],10,Ke),a("div",Oe,[s(f,{name:"lucide:message-square",class:"h-4 w-4"}),a("span",null,i(n.comment_count),1)])]),s(y,{variant:"ghost",size:"sm",onClick:T=>("navigateTo"in r?r.navigateTo:t(he))(`/community/posts/${n.id}`)},{default:o(()=>[...e[15]||(e[15]=[l("查看详情",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1024))),128)),t(F)?(d(),c("div",Qe,[s(y,{variant:"outline",disabled:t(p),onClick:Q},{default:o(()=>[l(i(t(p)?"加载中…":"加载更多"),1)]),_:1},8,["disabled"])])):w("",!0)])):(d(),c("div",Ie,i(t(W)),1))])]),a("aside",Xe,[s(j,{class:"border border-border/70"},{default:o(()=>[s(B,null,{default:o(()=>[s(C,null,{default:o(()=>[...e[16]||(e[16]=[l("社区概览",-1)])]),_:1}),s($,null,{default:o(()=>[...e[17]||(e[17]=[l("掌握成员结构与互动情况",-1)])]),_:1})]),_:1}),s(V,{class:"space-y-3 text-sm text-muted-foreground"},{default:o(()=>[a("p",null,[e[18]||(e[18]=a("strong",{class:"text-foreground"},"成员数：",-1)),l(i(t(u)?.members_count??0),1)]),a("p",null,[e[19]||(e[19]=a("strong",{class:"text-foreground"},"创建时间：",-1)),l(i(t(u)?P(t(u).created_at):"-"),1)]),a("p",null,[e[20]||(e[20]=a("strong",{class:"text-foreground"},"管理员：",-1)),l(i(t(u)?.current_role==="moderator"?"你是管理员":"由平台指定"),1)]),a("p",null,[e[21]||(e[21]=a("strong",{class:"text-foreground"},"访问权限：",-1)),l(i(t(u)?.is_private?"需要加入后访问":"公开社区"),1)])]),_:1})]),_:1}),s(j,{class:"border border-border/70 bg-muted/30"},{default:o(()=>[s(B,null,{default:o(()=>[s(C,null,{default:o(()=>[...e[22]||(e[22]=[l("互动提示",-1)])]),_:1}),s($,null,{default:o(()=>[...e[23]||(e[23]=[l("管理员可删除违规内容，维护社区秩序",-1)])]),_:1})]),_:1}),s(V,{class:"space-y-2 text-xs text-muted-foreground"},{default:o(()=>[...e[24]||(e[24]=[a("p",null,"· 建议使用案例+提示的结构分享信息。",-1),a("p",null,"· 如发现诈骗线索，可@社区管理员标记处理。",-1),a("p",null,"· 积极参与讨论可提升个人资料中的社区活跃度。",-1)])]),_:1})]),_:1})])])])}}});export{ut as default};
